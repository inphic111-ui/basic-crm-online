<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM 5.0 - æ­£å¼ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 28px;
            color: #667eea;
        }

        .header-right {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            overflow: hidden;
        }

        button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        button:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .nav-tab {
            padding: 10px 20px;
            background: #f0f0f0;
            color: #333;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .nav-tab:hover {
            background: #e0e0e0;
        }

        .nav-tab.active {
            background: #667eea;
            color: white;
        }

        .content {
            display: none;
        }

        .content.active {
            display: block;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }

        .stat-label {
            font-size: 14px;
            color: #999;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }

        .recent-customers {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }

        .login-page {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-container {
            width: 100%;
            max-width: 400px;
            padding: 20px;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .login-box h1 {
            font-size: 32px;
            color: #667eea;
            margin-bottom: 10px;
        }

        .login-box p {
            font-size: 16px;
            color: #666;
            margin-bottom: 30px;
        }

        .google-login-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px 30px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
        }

        .google-login-btn:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }        font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }

        .customer-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .customer-item:last-child {
            border-bottom: none;
        }

        .customer-name {
            font-weight: 500;
            color: #333;
        }

        .customer-email {
            font-size: 12px;
            color: #999;
        }

        .customers-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        input, select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        input {
            flex: 1;
            min-width: 200px;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        th {
            background: #f5f5f5;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #ddd;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background: #f9f9f9;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-small:hover {
            background: #764ba2;
        }

        .btn-danger {
            background: #ef4444;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }

        input[type="text"],
        input[type="email"],
        input[type="tel"],
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
        }

        .message {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .message-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .pagination {
            display: flex;
            gap: 5px;
            margin-top: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .pagination button {
            padding: 8px 12px;
            font-size: 12px;
        }

        .pagination button.active {
            background: #667eea;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            header {
                flex-direction: column;
                gap: 15px;
            }

            .nav-tabs {
                flex-wrap: wrap;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div id="loginPage" class="login-page" style="display: none;">
        <div class="login-container">
            <div class="login-box">
                <h1>ğŸ“Š CRM 5.0 - æ­£å¼ç‰ˆ</h1>
                <p>ä½¿ç”¨ Google å¸³è™Ÿç™»éŒ„</p>
                <a href="/api/auth/google/login" class="google-login-btn">
                    <span>ğŸ” ä½¿ç”¨ Google ç™»éŒ„</span>
                </a>
            </div>
        </div>
    </div>

    <div id="appPage" class="container" style="display: none;">
        <header>
            <h1>ğŸ“Š CRM 5.0 - æ­£å¼ç‰ˆ</h1>
            <div class="header-right">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">ç”¨</div>
                    <span id="userName">ç”¨æˆ¶</span>
                </div>
                <button onclick="logout()">ç™»å‡º</button>
            </div>
        </header>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('dashboard')">ğŸ“ˆ å„€è¡¨æ¿</button>
            <button class="nav-tab" onclick="switchTab('customers')">ğŸ‘¥ å®¢æˆ¶ç®¡ç†</button>
            <button class="nav-tab" onclick="switchTab('add-customer')">â• æ·»åŠ å®¢æˆ¶</button>
        </div>

        <!-- å„€è¡¨æ¿ -->
        <div id="dashboard" class="content active">
            <div class="dashboard-grid">
                <div class="stat-card">
                    <div class="stat-label">ç¸½å®¢æˆ¶æ•¸</div>
                    <div class="stat-value" id="totalCustomers">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æ´»èºå®¢æˆ¶</div>
                    <div class="stat-value" id="activeCustomers">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">éæ´»èºå®¢æˆ¶</div>
                    <div class="stat-value" id="inactiveCustomers">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">å®¢æˆ¶åˆ†é¡</div>
                    <div class="stat-value" id="totalCategories">0</div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-title">å®¢æˆ¶ç‹€æ…‹åˆ†ä½ˆ</div>
                    <canvas id="statusChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">å®¢æˆ¶åˆ†é¡åˆ†ä½ˆ</div>
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>

            <div class="recent-customers">
                <div class="recent-title">æœ€è¿‘æ·»åŠ çš„å®¢æˆ¶</div>
                <div id="recentCustomersList"></div>
            </div>
        </div>

        <!-- å®¢æˆ¶ç®¡ç† -->
        <div id="customers" class="content">
            <div class="customers-section">
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="æœç´¢å®¢æˆ¶åç¨±ã€éƒµç®±æˆ–å…¬å¸..." onkeyup="loadCustomers()">
                    <select id="statusFilter" onchange="loadCustomers()">
                        <option value="">æ‰€æœ‰ç‹€æ…‹</option>
                        <option value="active">æ´»èº</option>
                        <option value="inactive">éæ´»èº</option>
                        <option value="pending">è·Ÿé€²ä¸­</option>
                    </select>
                    <select id="categoryFilter" onchange="loadCustomers()">
                        <option value="">æ‰€æœ‰åˆ†é¡</option>
                    </select>
                    <button onclick="exportCSV()">ğŸ“¥ å°å‡º CSV</button>
                </div>

                <div id="message"></div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>åç¨±</th>
                                <th>éƒµç®±</th>
                                <th>é›»è©±</th>
                                <th>å…¬å¸</th>
                                <th>ç‹€æ…‹</th>
                                <th>åˆ†é¡</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="customersTable"></tbody>
                    </table>
                </div>

                <div class="pagination" id="pagination"></div>
            </div>
        </div>

        <!-- æ·»åŠ å®¢æˆ¶ -->
        <div id="add-customer" class="content">
            <div class="customers-section">
                <div class="modal-header">æ·»åŠ æ–°å®¢æˆ¶</div>
                <form onsubmit="addCustomer(event)">
                    <div class="form-group">
                        <label>å®¢æˆ¶åç¨± *</label>
                        <input type="text" id="customerName" required>
                    </div>
                    <div class="form-group">
                        <label>éƒµç®±</label>
                        <input type="email" id="customerEmail">
                    </div>
                    <div class="form-group">
                        <label>é›»è©±</label>
                        <input type="tel" id="customerPhone">
                    </div>
                    <div class="form-group">
                        <label>å…¬å¸</label>
                        <input type="text" id="customerCompany">
                    </div>
                    <div class="form-group">
                        <label>ç‹€æ…‹</label>
                        <select id="customerStatus">
                            <option value="active">æ´»èº</option>
                            <option value="inactive">éæ´»èº</option>
                            <option value="pending">è·Ÿé€²ä¸­</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>åˆ†é¡</label>
                        <input type="text" id="customerCategory" placeholder="ä¾‹å¦‚ï¼šVIPã€æ™®é€šã€æ½›åœ¨">
                    </div>
                    <div class="form-group">
                        <label>æ¨™ç±¤</label>
                        <input type="text" id="customerTags" placeholder="ç”¨é€—è™Ÿåˆ†éš”">
                    </div>
                    <div class="form-group">
                        <label>å‚™è¨»</label>
                        <textarea id="customerNotes"></textarea>
                    </div>
                    <div id="addMessage"></div>
                    <div class="modal-footer">
                        <button type="submit">ä¿å­˜å®¢æˆ¶</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ç·¨è¼¯å®¢æˆ¶æ¨¡æ…‹æ¡† -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">ç·¨è¼¯å®¢æˆ¶</div>
            <form onsubmit="updateCustomer(event)">
                <input type="hidden" id="editCustomerId">
                <div class="form-group">
                    <label>å®¢æˆ¶åç¨±</label>
                    <input type="text" id="editCustomerName" required>
                </div>
                <div class="form-group">
                    <label>éƒµç®±</label>
                    <input type="email" id="editCustomerEmail">
                </div>
                <div class="form-group">
                    <label>é›»è©±</label>
                    <input type="tel" id="editCustomerPhone">
                </div>
                <div class="form-group">
                    <label>å…¬å¸</label>
                    <input type="text" id="editCustomerCompany">
                </div>
                <div class="form-group">
                    <label>ç‹€æ…‹</label>
                    <select id="editCustomerStatus">
                        <option value="active">æ´»èº</option>
                        <option value="inactive">éæ´»èº</option>
                        <option value="pending">è·Ÿé€²ä¸­</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>åˆ†é¡</label>
                    <input type="text" id="editCustomerCategory">
                </div>
                <div class="form-group">
                    <label>æ¨™ç±¤</label>
                    <input type="text" id="editCustomerTags">
                </div>
                <div class="form-group">
                    <label>å‚™è¨»</label>
                    <textarea id="editCustomerNotes"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" onclick="closeEditModal()">å–æ¶ˆ</button>
                    <button type="submit">ä¿å­˜æ›´æ”¹</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentPage = 0;
        const itemsPerPage = 20;
        let statusChart, categoryChart;

        async function switchTab(tabName) {
            document.querySelectorAll('.content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'dashboard') {
                loadDashboard();
            } else if (tabName === 'customers') {
                loadCategories();
                loadCustomers();
            }
        }

        async function loadDashboard() {
            try {
                const response = await fetch('/api/dashboard');
                const data = await response.json();

                document.getElementById('totalCustomers').textContent = data.stats.total_customers;
                document.getElementById('activeCustomers').textContent = data.stats.active_customers;
                document.getElementById('inactiveCustomers').textContent = data.stats.inactive_customers;
                document.getElementById('totalCategories').textContent = data.stats.total_categories;

                // ç‹€æ…‹åˆ†ä½ˆåœ–è¡¨
                const statusCtx = document.getElementById('statusChart').getContext('2d');
                if (statusChart) statusChart.destroy();
                statusChart = new Chart(statusCtx, {
                    type: 'doughnut',
                    data: {
                        labels: data.statusDistribution.map(s => s.status),
                        datasets: [{
                            data: data.statusDistribution.map(s => s.count),
                            backgroundColor: ['#10b981', '#ef4444', '#f59e0b']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });

                // åˆ†é¡åˆ†ä½ˆåœ–è¡¨
                const categoryCtx = document.getElementById('categoryChart').getContext('2d');
                if (categoryChart) categoryChart.destroy();
                categoryChart = new Chart(categoryCtx, {
                    type: 'bar',
                    data: {
                        labels: data.categoryDistribution.map(c => c.category || 'æœªåˆ†é¡'),
                        datasets: [{
                            label: 'å®¢æˆ¶æ•¸',
                            data: data.categoryDistribution.map(c => c.count),
                            backgroundColor: '#667eea'
                        }]
                    },
                    options: {
                        responsive: true,
                        indexAxis: 'y',
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });

                // æœ€è¿‘å®¢æˆ¶
                const recentList = document.getElementById('recentCustomersList');
                recentList.innerHTML = data.recentCustomers.map(c => `
                    <div class="customer-item">
                        <div>
                            <div class="customer-name">${c.name}</div>
                            <div class="customer-email">${c.email || 'ç„¡éƒµç®±'}</div>
                        </div>
                        <div style="font-size: 12px; color: #999;">${new Date(c.created_at).toLocaleDateString('zh-TW')}</div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('åŠ è¼‰å„€è¡¨æ¿å¤±æ•—:', err);
            }
        }

        async function loadCustomers() {
            try {
                const search = document.getElementById('searchInput').value;
                const status = document.getElementById('statusFilter').value;
                const category = document.getElementById('categoryFilter').value;

                const params = new URLSearchParams({
                    search,
                    status,
                    category,
                    limit: itemsPerPage,
                    offset: currentPage * itemsPerPage
                });

                const response = await fetch(`/api/customers?${params}`);
                const data = await response.json();

                const tbody = document.getElementById('customersTable');
                tbody.innerHTML = data.customers.map(c => `
                    <tr>
                        <td>${c.name}</td>
                        <td>${c.email || '-'}</td>
                        <td>${c.phone || '-'}</td>
                        <td>${c.company || '-'}</td>
                        <td>${c.status === 'active' ? 'âœ“ æ´»èº' : c.status === 'inactive' ? 'âœ— éæ´»èº' : 'â³ è·Ÿé€²ä¸­'}</td>
                        <td>${c.category || '-'}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-small" onclick="editCustomer(${c.id})">ç·¨è¼¯</button>
                                <button class="btn-small btn-danger" onclick="deleteCustomer(${c.id})">åˆªé™¤</button>
                            </div>
                        </td>
                    </tr>
                `).join('');

                // åˆ†é 
                const totalPages = Math.ceil(data.total / itemsPerPage);
                const pagination = document.getElementById('pagination');
                pagination.innerHTML = '';
                for (let i = 0; i < totalPages; i++) {
                    const btn = document.createElement('button');
                    btn.textContent = i + 1;
                    btn.className = i === currentPage ? 'active' : '';
                    btn.onclick = () => {
                        currentPage = i;
                        loadCustomers();
                    };
                    pagination.appendChild(btn);
                }
            } catch (err) {
                console.error('åŠ è¼‰å®¢æˆ¶å¤±æ•—:', err);
            }
        }

        async function loadCategories() {
            try {
                const response = await fetch('/api/categories');
                const categories = await response.json();

                const select = document.getElementById('categoryFilter');
                select.innerHTML = '<option value="">æ‰€æœ‰åˆ†é¡</option>';
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    select.appendChild(option);
                });
            } catch (err) {
                console.error('åŠ è¼‰åˆ†é¡å¤±æ•—:', err);
            }
        }

        async function addCustomer(event) {
            event.preventDefault();

            try {
                const response = await fetch('/api/customers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: document.getElementById('customerName').value,
                        email: document.getElementById('customerEmail').value,
                        phone: document.getElementById('customerPhone').value,
                        company: document.getElementById('customerCompany').value,
                        status: document.getElementById('customerStatus').value,
                        category: document.getElementById('customerCategory').value,
                        tags: document.getElementById('customerTags').value,
                        notes: document.getElementById('customerNotes').value
                    })
                });

                if (response.ok) {
                    showMessage('å®¢æˆ¶æ·»åŠ æˆåŠŸï¼', 'success', 'addMessage');
                    event.target.reset();
                    setTimeout(() => switchTab('customers'), 1000);
                } else {
                    showMessage('æ·»åŠ å¤±æ•—', 'error', 'addMessage');
                }
            } catch (err) {
                showMessage('æ·»åŠ å¤±æ•—: ' + err.message, 'error', 'addMessage');
            }
        }

        async function editCustomer(id) {
            try {
                const response = await fetch(`/api/customers/${id}`);
                const customer = await response.json();

                document.getElementById('editCustomerId').value = customer.id;
                document.getElementById('editCustomerName').value = customer.name;
                document.getElementById('editCustomerEmail').value = customer.email || '';
                document.getElementById('editCustomerPhone').value = customer.phone || '';
                document.getElementById('editCustomerCompany').value = customer.company || '';
                document.getElementById('editCustomerStatus').value = customer.status;
                document.getElementById('editCustomerCategory').value = customer.category || '';
                document.getElementById('editCustomerTags').value = customer.tags || '';
                document.getElementById('editCustomerNotes').value = customer.notes || '';

                document.getElementById('editModal').classList.add('active');
            } catch (err) {
                console.error('åŠ è¼‰å®¢æˆ¶å¤±æ•—:', err);
            }
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
        }

        async function updateCustomer(event) {
            event.preventDefault();

            try {
                const id = document.getElementById('editCustomerId').value;
                const response = await fetch(`/api/customers/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: document.getElementById('editCustomerName').value,
                        email: document.getElementById('editCustomerEmail').value,
                        phone: document.getElementById('editCustomerPhone').value,
                        company: document.getElementById('editCustomerCompany').value,
                        status: document.getElementById('editCustomerStatus').value,
                        category: document.getElementById('editCustomerCategory').value,
                        tags: document.getElementById('editCustomerTags').value,
                        notes: document.getElementById('editCustomerNotes').value
                    })
                });

                if (response.ok) {
                    closeEditModal();
                    loadCustomers();
                    showMessage('å®¢æˆ¶æ›´æ–°æˆåŠŸï¼', 'success', 'message');
                }
            } catch (err) {
                console.error('æ›´æ–°å¤±æ•—:', err);
            }
        }

        async function deleteCustomer(id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å®¢æˆ¶å—ï¼Ÿ')) return;

            try {
                const response = await fetch(`/api/customers/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    loadCustomers();
                    showMessage('å®¢æˆ¶å·²åˆªé™¤', 'success', 'message');
                }
            } catch (err) {
                console.error('åˆªé™¤å¤±æ•—:', err);
            }
        }

        async function exportCSV() {
            try {
                const response = await fetch('/api/customers/export/csv');
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'customers.csv';
                a.click();
            } catch (err) {
                console.error('å°å‡ºå¤±æ•—:', err);
            }
        }

        function showMessage(msg, type, elementId) {
            const el = document.getElementById(elementId);
            el.innerHTML = `<div class="message message-${type}">${msg}</div>`;
            setTimeout(() => el.innerHTML = '', 5000);
        }

        function logout() {
            if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
                window.location.href = '/api/auth/logout';
            }
        }

        // æª¢æŸ¥èªè­‰ç‹€æ…‹
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/me');
                const user = await response.json();
                
                if (!user) {
                    document.getElementById('loginPage').style.display = 'flex';
                    document.getElementById('appPage').style.display = 'none';
                } else {
                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('appPage').style.display = 'block';
                    document.getElementById('userName').textContent = user.name || user.email;
                    if (user.picture) {
                        document.getElementById('userAvatar').innerHTML = `<img src="${user.picture}" style="width: 100%; height: 100%; border-radius: 50%;">`;
                    }
                    loadDashboard();
                }
            } catch (err) {
                console.error('æª¢æŸ¥èªè­‰å¤±æ•—:', err);
                document.getElementById('loginPage').style.display = 'flex';
                document.getElementById('appPage').style.display = 'none';
            }
        }

        // åˆå§‹åŒ–
        checkAuth();
    </script>
</body>
</html>
